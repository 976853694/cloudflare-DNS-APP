name: Build APK

on:
  # 推送到 main 分支时触发
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.kiro/**'
  
  # Pull Request 时触发
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.kiro/**'
  
  # 手动触发
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

  # Release 标签触发
  push:
    tags:
      - 'v*'

env:
  JAVA_VERSION: '17'
  ANDROID_BUILD_TOOLS_VERSION: '34.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android Build Tools
        run: |
          sdkmanager "build-tools;${{ env.ANDROID_BUILD_TOOLS_VERSION }}"
          echo "$ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS_VERSION }}" >> $GITHUB_PATH

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.android/cache
          key: ${{ runner.os }}-android-${{ env.ANDROID_BUILD_TOOLS_VERSION }}
          restore-keys: |
            ${{ runner.os }}-android-

      - name: Make scripts executable
        run: |
          chmod +x scripts/build-apk.sh
          chmod +x scripts/sign-apk.sh

      - name: Build unsigned APK
        run: |
          ./scripts/build-apk.sh unsigned.apk

      - name: Determine build type
        id: build_type
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.build_type }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_type }}" == "tag" ]; then
            echo "type=release" >> $GITHUB_OUTPUT
          else
            echo "type=debug" >> $GITHUB_OUTPUT
          fi

      - name: Generate Release Keystore
        run: |
          keytool -genkeypair \
            -alias release-key \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -keystore release.keystore \
            -storepass android123 \
            -keypass android123 \
            -dname "CN=Release,O=App,C=CN"

      - name: Sign APK (Debug)
        if: steps.build_type.outputs.type == 'debug'
        run: |
          ./scripts/sign-apk.sh unsigned.apk app-debug.apk --debug

      - name: Sign APK (Release)
        if: steps.build_type.outputs.type == 'release'
        run: |
          ./scripts/sign-apk.sh unsigned.apk app-release.apk \
            --keystore release.keystore \
            --keystore-pass android123 \
            --key-alias release-key \
            --key-pass android123

      - name: Get build info
        id: build_info
        run: |
          echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          if [ "${{ steps.build_type.outputs.type }}" == "debug" ]; then
            echo "apk_name=app-debug.apk" >> $GITHUB_OUTPUT
          else
            echo "apk_name=app-release.apk" >> $GITHUB_OUTPUT
          fi

      - name: Rename APK with metadata
        run: |
          APK_NAME="${{ steps.build_info.outputs.apk_name }}"
          NEW_NAME="app-${{ steps.build_type.outputs.type }}-${{ steps.build_info.outputs.short_sha }}-${{ steps.build_info.outputs.timestamp }}.apk"
          mv "$APK_NAME" "$NEW_NAME"
          echo "FINAL_APK=$NEW_NAME" >> $GITHUB_ENV

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ steps.build_type.outputs.type }}-${{ steps.build_info.outputs.short_sha }}
          path: ${{ env.FINAL_APK }}
          retention-days: 30

      - name: Upload to Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.FINAL_APK }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
